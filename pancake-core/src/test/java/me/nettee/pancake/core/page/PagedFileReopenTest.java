package me.nettee.pancake.core.page;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertTrue;

import java.io.File;
import java.io.IOException;
import java.util.Deque;
import java.util.HashSet;
import java.util.Set;

import org.apache.commons.lang3.RandomStringUtils;
import org.apache.commons.lang3.RandomUtils;
import org.junit.After;
import org.junit.Before;
import org.junit.BeforeClass;
import org.junit.Rule;
import org.junit.Test;
import org.junit.rules.ExpectedException;

public class PagedFileReopenTest {

	private static final File file = new File("/tmp/c.db");
	private PagedFile pagedFile;

	@BeforeClass
	public static void setUpBeforeClass() throws IOException {

	}

	@Before
	public void setUp() throws IOException {
		if (file.exists()) {
			file.delete();
		}
		pagedFile = PagedFile.create(file);
	}

	@After
	public void tearDown() {
		pagedFile.close();
	}

	public void reopen() {
		pagedFile.close();
		pagedFile = PagedFile.open(file);
	}

	@Rule
	public ExpectedException thrown = ExpectedException.none();

	@Test
	public void testNumberOfPages() {
		int N = PagedFilePageTest.allocatePages(pagedFile);
		reopen();
		assertEquals(N, pagedFile.getNumOfPages());
	}

    /**
     * All the allocated pages can be accessed.
     */
	@Test
	public void testPageNumberRange() {
		int N = PagedFilePageTest.allocatePages(pagedFile);
		reopen();
		for (int pageNum = 0; pageNum < N; pageNum++) {
			// except to be no exception
			pagedFile.getPage(pageNum);
		}
		thrown.expect(PagedFileException.class);
		pagedFile.getPage(N);
	}

    /**
     * All the allocated pages, except disposed ones, can be accessed.
     */
	@Test
	public void testDisposedPage() {
		int N = PagedFilePageTest.allocatePages(pagedFile);
		Deque<Integer> disposedPageNums = PagedFilePageTest.disposePages(pagedFile, N);
		reopen();
		for (int pageNum = 0; pageNum < N; pageNum++) {
			if (disposedPageNums.contains(pageNum)) {
				thrown.expect(PagedFileException.class);
				pagedFile.getPage(pageNum);
			} else {
				pagedFile.getPage(pageNum);
			}
		}
	}

    /**
     * The pageNums of disposed pages will be re-used for the following allocations.
     * // TODO check the LIFO re-use policy
     */
	@Test
	public void testReallocateDisposedPage() {
		int N = PagedFilePageTest.allocatePages(pagedFile);
		Deque<Integer> disposedPageNums = PagedFilePageTest.disposePages(pagedFile, N);
		reopen();
		Set<Integer> pageNumSet = new HashSet<>();
		for (int i = 0; i < disposedPageNums.size(); i++) {
			Page page = pagedFile.allocatePage();
			pageNumSet.add(page.num);
		}
		assertEquals(disposedPageNums.size(), pageNumSet.size());
		for (int pageNum : pageNumSet) {
			assertTrue(disposedPageNums.contains(pageNum));
		}
	}

	// TODO javadoc
    // TODO move this method to a util class
	static void fillPages(PagedFile pagedFile, String str0, int N) {
		for (int i = 0; i < N; i++) {
			Page page = pagedFile.getPage(i);
			pagedFile.markDirty(page.num);
			String str = str0 + i;
			PagedFilePageTest.putStringData(page, str);
		}
		pagedFile.forceAllPages();
	}

    // TODO javadoc
	@Test
	public void testGetPage() {
		String str0 = RandomStringUtils.randomAlphabetic(RandomUtils.nextInt(5, 10));
		int N = PagedFilePageTest.allocatePages(pagedFile);
		fillPages(pagedFile, str0, N);
		reopen();
		for (int pageNum = 0; pageNum < N; pageNum++) {
			Page page = pagedFile.getPage(pageNum);
			String str = PagedFilePageTest.getStringData(page, str0.length() + String.valueOf(pageNum).length());
			assertEquals(str0, str.substring(0, str0.length()));
			assertEquals(pageNum, (int) Integer.valueOf(str.substring(str0.length())));
		}
	}

	// TODO javadoc
	@Test
	public void testGetFirstPage() {
		String str0 = RandomStringUtils.randomAlphabetic(RandomUtils.nextInt(5, 10));
		int N = PagedFilePageTest.allocatePages(pagedFile);
		fillPages(pagedFile, str0, N);
		reopen();
		Page firstPage = pagedFile.getFirstPage();
		String str = PagedFilePageTest.getStringData(firstPage, str0.length() + 1);
		assertEquals(str0, str.substring(0, str0.length()));
		assertEquals(0, (int) Integer.valueOf(str.substring(str0.length())));
	}

	// TODO javadoc
	@Test
	public void testGetLastPage() {
		String str0 = RandomStringUtils.randomAlphabetic(RandomUtils.nextInt(5, 10));
		int N = PagedFilePageTest.allocatePages(pagedFile);
		fillPages(pagedFile, str0, N);
		reopen();
		Page lastPage = pagedFile.getLastPage();
		String str = PagedFilePageTest.getStringData(lastPage, str0.length() + String.valueOf(N - 1).length());
		assertEquals(str0, str.substring(0, str0.length()));
		assertEquals(N - 1, (int) Integer.valueOf(str.substring(str0.length())));
	}
	
	// TODO more test like those in PagedFilePageTest
}
